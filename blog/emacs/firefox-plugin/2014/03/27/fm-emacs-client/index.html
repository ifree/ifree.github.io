

<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>emacs as doubanfm client &#8211; Programming for fun!</title>
<meta name="description" content="晚上写东西喜欢听点小曲儿, 给自己放松放松. 我不太喜欢下载音乐, 更倾向于在线的形式,这样选择更多, 让我这种拖延症患者不至于听腻了没时间换. 所以 doubanfm 是个很好的选择. 之前给 firefox 写了个 doubanf...">
<meta name="keywords" content="doubanfm, emacs">


<meta property="og:locale" content="en_US">
<meta property="og:title" content="emacs as doubanfm client &#8211; Programming for fun!">
<meta property="og:description" content="晚上写东西喜欢听点小曲儿, 给自己放松放松. 我不太喜欢下载音乐, 更倾向于在线的形式,这样选择更多, 让我这种拖延症患者不至于听腻了没时间换. 所以 doubanfm 是个很好的选择. 之前给 firefox 写了个 doubanf...">
<meta property="og:url" content="http://programming4fun.com/blog/emacs/firefox-plugin/2014/03/27/fm-emacs-client">
<meta property="og:site_name" content="Programming for fun!">


<link href="http://programming4fun.com/feed.xml" type="application/atom+xml" rel="alternate" title="Programming for fun! Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Type -->
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Crimson+Text:400,400italic,700,700italic" rel='stylesheet' type='text/css' />
<link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://programming4fun.com/assets/css/entypo.css" media="all">

<!-- In order to use Calendas Plus, you must first purchase it. Then, create a font-face package using FontSquirrel.
<link rel='stylesheet' href='http://programming4fun.com/assets/cal.css' media='all' />
-->



<!-- For all browsers -->
<link rel="stylesheet" href="http://programming4fun.com/assets/css/i.css">

<!-- Fresh Squeezed jQuery -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="http://programming4fun.com/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://programming4fun.com/favicon.ico">

<div id="bump">
  <body class="">
    <header class="site-header darken">
      <div class="wrap">
        <hgroup>
          <h1><a href="/">Programming for fun!</a></h1>
        </hgroup>
        <a href="#nav" class="menu"><span class='icons'>☰</span></a>
        <nav role="navigation">
          <ul>
            <li>
              <a href="/" title="Programming for fun!">Home</a>
            </li>
            
            
                <li><a href="http://programming4fun.com/articles.html" >Blog</a></li>
            

          </ul>
        </nav>
      </div>
    </header>


<section class="article pad-top">




      <article class="wrap post">
        <header class="post-header">
          <hgroup>
            <h1>emacs as doubanfm client</h1>
            <p class="date">Mar 27, 2014</p>
            <p class="intro"></p>
          </hgroup>
        </header>

        <p>
晚上写东西喜欢听点小曲儿, 给自己放松放松. 我不太喜欢下载音乐, 更倾向于在线的形式,
这样选择更多, 让我这种拖延症患者不至于听腻了没时间换. 所以 doubanfm 是个很好的选
择. 
</p>

<p>
之前给 firefox 写了个 doubanfm html5 播放器, 用来解决 flash 插件耗电耗 cpu 的问题.
为了能让我的 doubanfm 得到更好的锻炼, 让机器学习的结果更加接近我的喜好, 我需要在
doubanfm 网站上做一些交互(跳过, 喜欢之类的). 这样我在遇到不喜欢的歌曲就需要我停下
手上的事情去切歌, 或者在思考的时候暂停. 这样太影响效率, 所以昨天晚上我停下手头上
的事情把这个东西写好了. (果然, 在拖延症面前, 其他小事都比当前的事重要 orz) 由于我
的主要开发工具是 emacs, 所以我就写了 emacs 插件. firefox 也是我的首选浏览器, 自由
度高, 足够开放, 可以各种 hack, 所以我也写了 ff 的插件, 主要方便我在其他 tab 中直
接切换歌曲而不用手动切到 doubanfm 的 tab. 
</p>

<p>
这完全是写着玩的, 大概介绍一下. 项目地址: <a href="https://github.com/ifree/douban-ff.git">https://github.com/ifree/douban-ff.git</a>
<!-- break -->  
</p>

<p>
你可能想知道 emacs 是如何与 firefox 交互的吧. 我用了一个插件 <a href="https://github.com/bard/mozrepl">moz-repl</a>, 其内部会创
建一个 <code>server_socket</code> 对象来处理请求, 把接收到的请求作为 js 脚本执行, 所以
emacs 只需要向它发送 js 脚本就可以完成执行操作. moz-repl 其实也是一个 ff 插件开发
利器. 再贴一点具体实现的代码, 如下:
</p>

<div class="org-src-container">

<pre class="src src-emacs-lisp"><span style="color: #8c8c8c;">(</span><span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">send-to-ff</span> <span style="color: #93a8c6;">(</span>content<span style="color: #93a8c6;">)</span>
<span style="color: #ffa07a;">"send js to firefox to execute"</span>
  <span style="color: #93a8c6;">(</span>comint-send-string <span style="color: #b0b1a3;">(</span>inferior-moz-process<span style="color: #b0b1a3;">)</span>
                      content
                      <span style="color: #93a8c6;">)</span>
  <span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">ff-exec-script-in-tabs</span> <span style="color: #93a8c6;">(</span>script url-regex<span style="color: #93a8c6;">)</span> 
<span style="color: #ffa07a;">"script injection"</span>
  <span style="color: #93a8c6;">(</span>send-to-ff
   <span style="color: #b0b1a3;">(</span>format <span style="color: #ffa07a;">"</span>
<span style="color: #ffc0cb; font-weight: bold;">(</span><span style="color: #ffa07a;">function(script,u){</span>
<span style="color: #ffa07a;">        [].forEach.call(gBrowser.tabs,function(itm){</span>
<span style="color: #ffa07a;">            var ctab=itm.linkedBrowser;</span>
<span style="color: #ffa07a;">            if(ctab.contentDocument.location.host.match(u)){</span>
<span style="color: #ffa07a;">                var s=ctab.contentDocument.createElement('script')</span>
<span style="color: #ffa07a;">                s.textContent=script;</span>
<span style="color: #ffa07a;">                ctab.contentDocument.body.appendChild(s);</span>
<span style="color: #ffa07a;">            }</span>
<span style="color: #ffa07a;">        });        </span>
<span style="color: #ffa07a;">    })(\"%s\",\"%s\");</span>
<span style="color: #ffa07a;">"</span>
script url-regex
<span style="color: #b0b1a3;">)</span>
   <span style="color: #93a8c6;">)</span>
  <span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">fm-skip</span> <span style="color: #93a8c6;">()</span>
  <span style="color: #93a8c6;">(</span>interactive<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>fm-exec <span style="color: #ffa07a;">"DBR.act('skip')"</span><span style="color: #93a8c6;">)</span>
  <span style="color: #8c8c8c;">)</span>

<span style="color: #8c8c8c;">(</span><span style="color: #00ffff;">defun</span> <span style="color: #87cefa;">fm-copy-song</span> <span style="color: #93a8c6;">()</span>
  <span style="color: #93a8c6;">(</span>interactive<span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>fm-exec <span style="color: #ffa07a;">"document.title=FM.getCurrentSongInfo().url"</span><span style="color: #93a8c6;">)</span>
  <span style="color: #93a8c6;">(</span>send-to-ff <span style="color: #ffa07a;">"</span>
<span style="color: #ffc0cb; font-weight: bold;">[</span><span style="color: #ffa07a;">].forEach.call(gBrowser.tabs,function(itm){</span>
<span style="color: #ffa07a;">            var ctab=itm.linkedBrowser;</span>
<span style="color: #ffa07a;">            if(ctab.contentDocument.location.host.match('douban\.fm')){</span>
<span style="color: #ffa07a;">                Components.classes['@mozilla.org/widget/clipboardhelper;1']</span>
<span style="color: #ffa07a;">                .getService(Components.interfaces.nsIClipboardHelper)</span>
<span style="color: #ffa07a;">                .copyString(ctab.contentTitle);</span>
<span style="color: #ffa07a;">            }});"</span>
<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
</pre>
</div>


<p>
关键点就在如何向 firefox 的某个 tab 注入代码, 很简单, 动态构建 script. 
</p>


<p>
好了, 工具也写好了, 继续做事 :&gt;
</p>



      

      <aside class="disqus">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'programming4fun'; // required: replace example with your forum shortname

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</aside>


      

      </article>
    </section>
</div>

<div class="push"></div>

  <footer>
    <aside class="wrap">
      <ol class="prev-posts">
        <p class="list-title">Recent Posts</p>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="http://programming4fun.com/blog/dev/2014/08/15/introduce-to-docker" title="Introduce to docker">Introduce to docker </a></span>
              <span class="date">Aug 15, 2014</span>
            </li>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="http://programming4fun.com/blog/dev/2014/06/28/deobfuscate-javascript-with-emacs" title="deobfuscate javascript with emacs">deobfuscate javascript with... </a></span>
              <span class="date">Jun 28, 2014</span>
            </li>
         <!-- for1 -->
            <li>
              <span class="recent-title"><a href="http://programming4fun.com/blog/emacs/firefox-plugin/2014/03/27/fm-emacs-client" title="emacs as doubanfm client">emacs as doubanfm client </a></span>
              <span class="date">Mar 27, 2014</span>
            </li>
        
      </ol>

      <div class="social">
        <ul>
	    

	    
            <li><a id="gplus" href="https://plus.google.com/+FreiZhang?rel=author" target="_blank"><span class="foot-link">+FreiZhang</span></a></li>
	    

            

        </ul>
    </div>
    </aside>

    <small>&copy; 2014 <a href="https://plus.google.com/+FreiZhang?rel=author">Frei Zhang</a>. Powered by <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://orgmode.org">org-mode</a> theme based on Balzac.</small>
  </footer>

  
<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-40326102-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  <!-- If they're out, get some from the cellar -->
  <script>window.jQuery || document.write('<script src="http://programming4fun.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
  <script src="http://programming4fun.com/assets/js/retina.min.js"></script>

  <!-- Custom JS -->
  <script src="http://programming4fun.com/assets/js/scripts.js"></script>


  </body>
</html>

